<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>–°–¥–µ–ª–∞—Ç—å —Ñ–æ—Ç–æ </title>
<style>
body { font-family: Arial; padding:20px; max-width:700px; margin:auto; }
h1 { color:#2b6cb0; }
video, canvas { width:100%; border-radius:8px; background:#000; }
button { margin-top:10px; padding:10px 16px; font-size:16px; border-radius:8px; cursor:pointer; }
#status { margin-top:10px; color:#333; }
</style>
</head>
<body>
<h1>–°–¥–µ–ª–∞–π —Ñ–æ—Ç–æ üòä</h1>
<p>–ù–∞–∂–º–∏ ¬´–í–∫–ª—é—á–∏—Ç—å –∫–∞–º–µ—Ä—É¬ª, –¥–∞–π —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ, –∑–∞—Ç–µ–º ¬´–°–¥–µ–ª–∞—Ç—å —Ñ–æ—Ç–æ¬ª. –ü–æ—Å–ª–µ ¬´–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ñ–æ—Ç–æ¬ª –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —É–π–¥—ë—Ç –Ω–∞ —Å–µ—Ä–≤–µ—Ä.</p>

<video id="video" autoplay playsinline></video>
<canvas id="canvas" style="display:none;"></canvas><br>

<button id="startBtn">–í–∫–ª—é—á–∏—Ç—å –∫–∞–º–µ—Ä—É</button>
<button id="photoBtn" disabled>–°–¥–µ–ª–∞—Ç—å —Ñ–æ—Ç–æ</button>
<button id="uploadBtn" disabled>–ò—Å–∫–∞—Ç—å –¥–≤–æ–π–Ω–∏–∫–∞</button>

<p id="status">–°—Ç–∞—Ç—É—Å: –æ–∂–∏–¥–∞–Ω–∏–µ</p>

<script>
const token = "{{TOKEN}}";
const v = document.getElementById('video');
const c = document.getElementById('canvas');
const s = document.getElementById('status');
const startBtn = document.getElementById('startBtn');
const photoBtn = document.getElementById('photoBtn');
const uploadBtn = document.getElementById('uploadBtn');
let stream = null;

startBtn.onclick = async () => {
  try {
    stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" }, audio: false });
    v.srcObject = stream;
    photoBtn.disabled = false;
    s.textContent = '–ö–∞–º–µ—Ä–∞ –≤–∫–ª—é—á–µ–Ω–∞. –ù–∞–∂–º–∏ ¬´–°–¥–µ–ª–∞—Ç—å —Ñ–æ—Ç–æ¬ª.';
  } catch (e) {
    s.textContent = '–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ: ' + e.message;
  }
};

photoBtn.onclick = () => {
  if (!stream) return;
  c.width = v.videoWidth; c.height = v.videoHeight;
  c.getContext('2d').drawImage(v, 0, 0);
  c.style.display = 'block';
  uploadBtn.disabled = false;
  s.textContent = '–§–æ—Ç–æ –≥–æ—Ç–æ–≤–æ. –ú–æ–∂–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å.';
};

uploadBtn.onclick = () => {
  c.toBlob(async (blob) => {
    if (!blob) { s.textContent = '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ.'; return; }
    const fd = new FormData();
    fd.append('photo', blob, 'photo.png');
    fd.append('token', token);
    s.textContent = '–û—Ç–ø—Ä–∞–≤–∫–∞...';
    try {
      const r = await fetch('/upload_photo', { method: 'POST', body: fd });
      const j = await r.json();
      if (r.ok) {
        s.innerHTML = '–§–æ—Ç–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ: <a href="' + j.url + '" target="_blank" rel="noopener">–æ—Ç–∫—Ä—ã—Ç—å</a>';
      } else {
        s.textContent = '–û—à–∏–±–∫–∞: ' + (j.error || r.statusText);
      }
    } catch (e) {
      s.textContent = '–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + e.message;
    }
  }, 'image/png');
};
</script>
</body>
</html>